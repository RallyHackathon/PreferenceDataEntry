<!DOCTYPE html>
<html>
<head>
    <title>PreferenceDataEntry</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"mainContainer",layout:"vbox",padding:10}],appWorkspace:null,appPrefName:"buildList6",appPref:null,buildCombobox:null,rCB:null,launch:function(){var buildAddContainer=Ext.create("Ext.container.Container",{itemId:"bAddContainer",layout:"vbox",width:600,height:160,border:"0 0 1 0",style:{borderColor:"grey",borderStyle:"solid"},padding:"0 0 10 0"}),buildAddContainerInner=Ext.create("Ext.container.Container",{itemId:"bAddContainerInner",layout:"vbox"});this.buildRemoveContainer=Ext.create("Ext.container.Container",{itemId:"bRemoveContainer",layout:"vbox",width:600,height:60,padding:"10 0 0 0"});var buildDateContainer=Ext.create("Ext.container.Container",{itemId:"bDateContainer",layout:"hbox"});this.appWorkspace=this.getContext().getWorkspaceRef();var tfKey=Ext.create("Rally.ui.TextField",{itemId:"tfK",fieldLabel:"Build Number",padding:10}),dfValue=Ext.create("Rally.ui.DateField",{itemId:"dfV",fieldLabel:"Build Date",value:new Date,padding:10}),tfValue=Ext.create("Ext.form.field.Time",{itemId:"tfV",fieldLabel:"Build Time (24 hour style)",maxValue:"23:59",minValue:"0:00",increment:15,format:"H:i",value:new Date,padding:10}),buttonAdd=Ext.create("Rally.ui.Button",{text:"Add Build",width:100,handler:this._onButtonAddClick,scope:this});this.rCB=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"relCB",listeners:{change:function(){buildAddContainer.add(buttonAdd),console.log("changed"),this._displayGrid()},scope:this}}),buildDateContainer.add(dfValue),buildDateContainer.add(tfValue),buildAddContainerInner.add(this.rCB),buildAddContainerInner.add(tfKey),buildAddContainerInner.add(buildDateContainer),buildAddContainerInner.add(buttonAdd),buildAddContainer.add(buildAddContainerInner),this.down("#mainContainer").add(buildAddContainer),this.down("#mainContainer").add(this.buildRemoveContainer)},_onButtonRemoveClick:function(){var buildToRemove=this.buildCombobox.getRawValue();if(""!==buildToRemove){console.log("build to remove",buildToRemove);var newList=_.filter(this.appPrefValue,function(num){return num.build!=buildToRemove});console.log("removed build list",newList),this._saveNewPrefs(newList)}},_onButtonAddClick:function(){var buildKey=this.down("#tfK").getValue();if(""!==buildKey){console.log("build",buildKey);var buildDateValue=this.down("#dfV").getValue(),buildTimeValue=this.down("#tfV").getValue(),buildTimeStamp=new Date(buildDateValue.getFullYear()+"-"+(buildDateValue.getMonth()+1)+"-"+buildDateValue.getDate()+" "+buildTimeValue.getHours()+":"+buildTimeValue.getMinutes()+":"+buildTimeValue.getSeconds());console.log("stamp",buildTimeStamp),console.log("buildDateValue",buildDateValue),console.log("month",buildDateValue.getMonth()),console.log("day",buildDateValue.getDate()),console.log("appPrefValue init",this.appPrefValue),this.appPrefValue.push({build:buildKey,date:buildTimeStamp.toISOString()}),console.log("buildTimestamp to string",buildTimeStamp.toISOString()),this._saveNewPrefs(this.appPrefValue)}},_saveNewPrefs:function(prefValue){var appPrefValueEncoded=Ext.JSON.encode(prefValue),newPref={};newPref[this.appPrefName]=appPrefValueEncoded,console.log("newPref",newPref),Rally.data.PreferenceManager.update({settings:newPref,workspace:this.appWorkspace,success:function(updatedRecords,notUpdatedRecords){console.log("Pair saved",updatedRecords),console.log("this",this),this._displayGrid()},scope:this})},_displayGrid:function(){this.prefGrid&&(this.prefGrid.destroy(),console.log("grid destroyed")),console.log(this.down("#grid")),Rally.data.PreferenceManager.load({workspace:this.appWorkspace,filterByName:this.appPrefName,success:function(pref){console.log("loaded pref",pref,pref[this.appPrefName]);var decodedPrefValue=Ext.JSON.decode(pref[this.appPrefName]);this.appPrefValue=void 0===decodedPrefValue?[]:decodedPrefValue,console.log("decoded pref value",this.appPrefValue);var relEndDate=this.rCB.findRecordByValue(this.rCB.getValue()).get("ReleaseDate").toISOString(),relStartDate=this.rCB.findRecordByValue(this.rCB.getValue()).get("ReleaseStartDate").toISOString();console.log("release start date",relStartDate),console.log("release end date",relEndDate),this.relBuildsPrefValues=_.filter(this.appPrefValue,function(obj){return console.log("obj.date",obj.date),console.log("relendDate",relEndDate),relEndDate>obj.date&&obj.date>relStartDate}),console.log("filtered builds",this.relBuildsPrefValues);var prefStoreRelease=Ext.create("Rally.data.custom.Store",{data:this.relBuildsPrefValues,storeId:"pStore",columnCfgs:[{text:"Build",dataIndex:"build"},{text:"Build Timestamp",dataIndex:"date"}]});this.buildCombobox&&(this.buildCombobox.destroy(),this.buttonRemove.destroy()),this.buildCombobox=Ext.create("Ext.form.ComboBox",{fieldLabel:"Choose Build",itemId:"buildToRemoveCB",store:prefStoreRelease,displayField:"build",valueField:"date",renderTo:Ext.getBody(),scope:this}),this.buttonRemove=Ext.create("Rally.ui.Button",{text:"Remove Build",width:100,handler:this._onButtonRemoveClick,scope:this}),this.down("#bRemoveContainer").add(this.buildCombobox),this.down("#bRemoveContainer").add(this.buttonRemove),console.log("retrieved store",Ext.data.StoreManager.lookup("pStore")),this.prefGrid=Ext.create("Rally.ui.grid.Grid",{itemId:"grid",store:Ext.data.StoreManager.lookup("pStore"),title:"BUILD HISTORY",columnCfgs:[{text:"Build",dataIndex:"build",flex:1},{text:"Build Timestamp",dataIndex:"date",flex:5}],rowLines:!0,showPagingToolbar:!1,columnLines:!0}),console.log("grid found",this.prefGrid),this.add(this.prefGrid)},scope:this})}});

            Rally.launchApp('CustomApp', {
                name:"PreferenceDataEntry",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body></body>
</html>
